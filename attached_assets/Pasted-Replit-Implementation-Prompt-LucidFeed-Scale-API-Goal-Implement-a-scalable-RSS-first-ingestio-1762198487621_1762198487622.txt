Replit Implementation Prompt ‚Äî LucidFeed Scale & API

Goal: Implement a scalable, RSS‚Äëfirst ingestion + selective enrichment architecture, harden API usage (rate limits, backoff, caching), and ship onboarding + payments + smarter chat per the current plan.

‚∏ª

üîß What to Build (Scope)
	1.	Feed Discovery Service (YouTube/Podcasts/Reddit/Substack/Journals) using RSS for discovery.
	2.	Feed Discovery UI with Search and Onboarding Wizard (first‚Äëlogin flow).
	3.	Stripe Subscription Flow with tiers (Free, Premium, Pro) and enforce feature gates.
	4.	User‚Äëlevel Digest Generation (weekly/daily) with cached, reusable summaries.
	5.	Enhanced Conversational Chat (two‚Äëstage: retrieve ‚Üí summarize/synthesize) + Chat History Persistence.
	6.	Scale & API Safety: BullMQ queues, per‚Äësource concurrency, backoff, caching, canonical merge, and observability.

Prioritize: (A) Feed Discovery Service ‚Üí (B) Discovery UI + Onboarding ‚Üí (C) Chat improvements ‚Üí (D) Stripe + Digests ‚Üí (E) Ops hardening (queues/metrics).

‚∏ª

‚úÖ Acceptance Criteria (Definition of Done)
	‚Ä¢	No hard API dependencies for ingestion (RSS‚Äëfirst for all sources). Enrichment uses safe, cached calls.
	‚Ä¢	Per‚Äësource concurrency + backoff to avoid 429s; failures don‚Äôt cascade. Dead‚Äëletter queue captures persistent failures.
	‚Ä¢	Canonical merge: items deduped by DOI or normalized URL; social posts linked via related_refs.
	‚Ä¢	Onboarding flow: user selects topics ‚Üí sees curated sources/bundles ‚Üí one‚Äëclick add ‚Üí digest created within first session.
	‚Ä¢	Chat can summarize an entire digest with citations to included items; hallucination guardrails enforced.
	‚Ä¢	Stripe plans work end‚Äëto‚Äëend with portal; feature gates respected per tier; token/cost usage tracked per user.
	‚Ä¢	Observability: healthcheck + Sentry + structured logs; PostHog basic funnel events wired.

‚∏ª

üß± Architectural Requirements (API & Scale)

1) Ingestion Strategy
	‚Ä¢	Discovery: RSS only for YouTube (channel feeds), Podcasts (PodcastIndex ‚Üí RSS), Reddit (subreddit RSS), Substack (site RSS), Journals (PubMed/Crossref search results ‚Üí stored as sources).
	‚Ä¢	Content Fetch:
	‚Ä¢	YouTube transcripts: use youtube-transcript selectively behind a queue (no API key). If captions missing, fallback to description.
	‚Ä¢	Podcasts: RSS description shown; optional transcript only if explicitly available.
	‚Ä¢	Substack/Reddit: consume RSS content; avoid HTML scraping unless necessary.
	‚Ä¢	Journals: PubMed/Crossref/Semantic Scholar for metadata; Unpaywall PDFs where available.

2) Rate Limits & Backoff (Per‚ÄëSource Policies)
	‚Ä¢	Global: implement BullMQ queues with per‚Äësource concurrency caps and retry policies:
	‚Ä¢	YouTube transcripts: concurrency 5‚Äì10, backoff exponential (initial 2s, factor 2, jitter), max retries 5.
	‚Ä¢	RSS pulls: concurrency 50, respect ETag/Last-Modified; min interval per feed 10‚Äì30 min.
	‚Ä¢	PubMed/Crossref/S2: obey provider guidance;
	‚Ä¢	PubMed: with API key target ‚â§ 10 req/sec; without key ‚â§ 3 req/sec; set tool and email headers.
	‚Ä¢	Crossref/S2: identify app via User-Agent; follow Retry-After.
	‚Ä¢	Dead‚Äëletter queues for persistent 4xx/5xx; alert when DLQ > threshold.

3) Canonicalization & Merge
	‚Ä¢	Canonical ID: doi || normalizedURL(host+path); hash as canonicalId.
	‚Ä¢	Normalization: lowercase host, strip UTM + fragments, drop trailing slash.
	‚Ä¢	Merge rules: Reddit/Substack/YouTube items that reference a DOI/URL do not create new primaries; they become related_refs linked to the canonical item.

4) Selective Enrichment (Cost Control)
	‚Ä¢	Scoring pre‚Äëpass (cheap): source authority + recency + basic engagement proxy (channel age, subscriber tier if available, or heuristic).
	‚Ä¢	Transcript fetch only for the top 10‚Äì20% by score.
	‚Ä¢	LLM summarization only for the top 2‚Äì5% or when an item is placed in a user‚Äôs digest (demand‚Äëdriven).
	‚Ä¢	Cache all transcripts and summaries; reuse across users/digests.

5) Chat Architecture
	‚Ä¢	Two‚Äëstage pipeline: (1) retrieve top N items (or whole digest) ‚Üí (2) summarizer/synthesizer with strict cite‚Äëonly constraints.
	‚Ä¢	Modes: summarize_digest, answer_question, compare_items, debunk (each with tailored prompts).
	‚Ä¢	Guardrails: ‚ÄúAnswer only from provided items; if insufficient, ask for more context.‚Äù
	‚Ä¢	Store prompt_version & `model